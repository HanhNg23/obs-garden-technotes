---
{"dg-publish":true,"dg-permalink":"spring-oauth2","permalink":"/spring-oauth2/","noteIcon":"1"}
---


# OAuth2 

## 1 - OAuth2 Overview
![](https://i.imgur.com/b9inffD.png)
<span style="color:#555555">Protocol flow - the abstract OAuth 2.0 flow illustrated in Figure above describe the interaction between the 4 roles and its steps</span>
üçé <span style="color:#d4a216">Source</span> : [Link](https://datatracker.ietf.org/doc/html/rfc6749#autoid-3)
## 2 - OAuth2 Log In
- **The OAuth 2.0 Login** lets an application have **users log into the application** by **using** their **existing account** at an **OAuth 2.0 Provider - such as GITHUB |OR| OpenID Connect 1.0 Provider (such as Google)**.
### 2.1 - Core Configuration
- The Spring Boot provides full auto - configuration for OAuth2.0 Login.
	- See the example shows how to configure the OAuth2 Login by using Google as the Authentication Provider [See](https://docs.spring.io/spring-security/reference/servlet/oauth2/login/core.html#oauth2login-sample-initial-setup)
	 <span style="color:#d4a216">Summary for implement default configuration of OAuth2 Login </span>
	- 1 - Completing the "**Obtain OAuth2.0 credentials**" instructions to get your app new OAuth Client with **credentials consisting of a Client ID & Client Secret**.
		- example for Google Credentials :
		   ![](https://i.imgur.com/MUa10Oq.png)
	- 2 - Setting Redirect URI - the path in the application that that the end-user's user-agent is redirected back to after they have authenticated with Google and have granted access to the OAuth Client
		- ![](https://i.imgur.com/2Sc46wp.png)
	- 3 - Configure application.yml - when you have a new OAuth Client at step 1 --> configure the application to use the OAuth Client for the authentication flow. The configuration follows the format: 
		- ![](https://i.imgur.com/Cd5xtTE.png)
	- 4 - Boot up the Application - default the Spring Boot 2.x app will be launch to go to localhost 8080 and then redirected to the default auto-generated login page which displays a link for Google. 
		- ![](https://i.imgur.com/VgirjD6.png)
- üëâ Custom more configuration for Spring Boot 2.x OAuth Client properties by following templates [See](https://docs.spring.io/spring-security/reference/servlet/oauth2/login/core.html#oauth2login-boot-property-mappings)
- CommonOAuth2Provider pre-defines
	- CommonOAuth2Provider pre-defines a set of default client properties for a number of well known providers includes: Google, GitHub, Facebook, and Okta. In addition, the authorization-uri, token-uri, user-info-uri do not change often for a provider ---> Therefore, with common Oauth2 Provider, Spring Se support default values ---> developer just set up client-id and client-secret.
		![](https://i.imgur.com/7EP0WNY.png)
	- üëï Custom your own OAuth2Provider/registrationId - for cases where you may want to specify a different `registrationId` such as goolge-login --> *config the provider property*
		- ![](https://i.imgur.com/cgNMV88.png)
	- ![](https://i.imgur.com/jp0PwFk.png)
- Configuring Custom Provider Properties - support multi-tenancy
	- For the purpose providing supports multi-tenancy for some OAuth2.0 Provider require.
	- `Multi-tenancy` - means using different protocol endpoints for each tenant/sub-model.
		For example: an OAuth Client registration with Okta is assigned to a specific sub-domain and have their own protocol endpoints.
	- üëï Let go to config custom provider properties: `spring.security.oauth2.client.provider._[providerId]_`
		- ![](https://i.imgur.com/wPjyCVE.png)
- Overriding Spring Boot 2.x Auto-Configuration
	- The auto-configuration class for <span style="color:#00b0f0">**OAuth Client support is `OAuth2ClientAutoConfiguration`. Performing the following tasks:**</span>
		- <span style="color:#00b0f0">Registers a `ClientRegistrationRepository` `@Bean` which composed of `ClientRegistration`(s) (like Github, Facebook, ... other OAuth2 Providers) from OAuth Client properties.</span>
		- <span style="color:#00b0f0">Registers a `SecurityFilterChain` @Bean and enables OAuth2.0 Login through `httpSecurity.oauth2Login()`</span>
			- ![](https://i.imgur.com/m3X7nMo.png)
		-  ‚≠ê To Override the auto-configuration --> do so in the following ways: 
			- [Register a ClientRegistrationRepository @Bean](https://docs.spring.io/spring-security/reference/servlet/oauth2/login/core.html#oauth2login-register-clientregistrationrepository-bean)
			- [Register a SecurityFilterChain @Bean](https://docs.spring.io/spring-security/reference/servlet/oauth2/login/core.html#oauth2login-provide-securityfilterchain-bean)
			- [Completely Override the Auto-configuration](https://docs.spring.io/spring-security/reference/servlet/oauth2/login/core.html#oauth2login-completely-override-autoconfiguration)
	- Java Configuration without Spring Boot 2.x - if you not able to use Spring Boot 2.x and would like to configure one of the pre-defined providers in CommonOAuth2Provider like Google for ex -> [See](https://docs.spring.io/spring-security/reference/servlet/oauth2/login/core.html#oauth2login-javaconfig-wo-boot)

### 2.2 - Advanced Configuration
- HttpSecurity.oauth2Login() provides a number of configuration options for customizing OAuth 2.0 Login 
- <span style="color:#d4a216">The **main configuration** options are **grouped into their protocol endpoint counterparts** includes :</span>
	```Java
		@Configuration
		@EnableWebSecurity
		public class OAuth2LoginSecurityConfig {
			@Bean
			public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
				http
					.oauth2Login(oauth2 -> oauth2
					    .authorizationEndpoint(authorization -> authorization
					            ...
					    )
					    .redirectionEndpoint(redirection -> redirection
					            ...
					    )
					    .tokenEndpoint(token -> token
					            ...
					    )
					    .userInfoEndpoint(userInfo -> userInfo
					            ...
					    )
					);
				return http.build();
			}
		}
	```
- The authorization process uses <span style="color:#d4a216">2 authorization server endpoints (HTTP resources)</span> :
	- [`authorizationEndpoint`](https://datatracker.ietf.org/doc/html/rfc6749#section-3.1) - used by the client (your application) to obtain authorization from the resource owner through user-agent redirection.
	- [`tokenEndpoint`](https://datatracker.ietf.org/doc/html/rfc6749#section-3.2) - used by the client to exchange an authorization grant  for an access token
- The authorization process also uses <span style="color:#d4a216">one client endpoint</span> :
	- `redirectionEndpoint` - used by the authorization server to return response that contain authorization credentials to the client/your server through the resource owner user-agent.
- The OpenID Connect Core 1.0 specifications defines the [UserInfo Endpoint](https://openid.net/specs/openid-connect-core-1_0.html#UserInfo) as follows: 
	- `userInfoEndpoint` - is an OAuth 2.0 Protected Resource that returns <span style="color:#00b0f0">claims about the authenticated end-user</span>.
	- üëï ---> To obtain the requested claims about the end-user 
		  ---> the client makes a request to the UserInfo Endpoint by using an access token which obtained through OpenID Connect Authentication. 
			![](https://i.imgur.com/UNpoVMg.png)
		  ---> these claims are normally represented by a JSON object that contains a collection of name-value pairs for the claims
			![](https://i.imgur.com/2ceOxc4.png)
	- üçé Reference: [UserInfo Endpoint](https://openid.net/specs/openid-connect-core-1_0.html#UserInfo)
- See the complete OAuth2 login configuration options
	```Java
			@Configuration
			@EnableWebSecurity
			public class OAuth2LoginSecurityConfig {
			
				@Bean
				public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
					http
						.oauth2Login(oauth2 -> oauth2
						    .clientRegistrationRepository(this.clientRegistrationRepository())
						    .authorizedClientRepository(this.authorizedClientRepository())
						    .authorizedClientService(this.authorizedClientService())
						    .loginPage("/login")
						    .authorizationEndpoint(authorization -> authorization
						        .baseUri(this.authorizationRequestBaseUri())
						        .authorizationRequestRepository(this.authorizationRequestRepository())
						        .authorizationRequestResolver(this.authorizationRequestResolver())
						    )
						    .redirectionEndpoint(redirection -> redirection
						        .baseUri(this.authorizationResponseBaseUri())
						    )
						    .tokenEndpoint(token -> token
						        .accessTokenResponseClient(this.accessTokenResponseClient())
						    )
						    .userInfoEndpoint(userInfo -> userInfo
						        .userAuthoritiesMapper(this.userAuthoritiesMapper())
						        .userService(this.oauth2UserService())
						        .oidcUserService(this.oidcUserService())
						    )
						);
					return http.build();
				}
			}
	```
- The following sections go into more detail on each of the configuration options available:
	- [OAuth 2.0 Login Page](https://docs.spring.io/spring-security/reference/servlet/oauth2/login/advanced.html#oauth2login-advanced-login-page) - Let go to customize the default login page which has already shows each configured OAuth Client with its `ClientRegistration.clientName` as a link
	
	 - [Redirection Endpoint](https://docs.spring.io/spring-security/reference/servlet/oauth2/login/advanced.html#oauth2login-advanced-redirection-endpoint) - customize the call back endpoint which the Authorization server uses for returning the Authorization Response(contains the authorization credentials) to the client through Resource Owner user-agent.
	
	 - üìåüìåüìåüìå[UserInfo Endpoint](https://docs.spring.io/spring-security/reference/servlet/oauth2/login/advanced.html#oauth2login-advanced-userinfo-endpoint) - provide a number of configuration options includes [Mapping User Authorities](https://docs.spring.io/spring-security/reference/servlet/oauth2/login/advanced.html#oauth2login-advanced-map-authorities) ; [OAuth 2.0 UserService](https://docs.spring.io/spring-security/reference/servlet/oauth2/login/advanced.html#oauth2login-advanced-oauth2-user-service) ; [OpenID Connect 1.0 UserService](https://docs.spring.io/spring-security/reference/servlet/oauth2/login/advanced.html#oauth2login-advanced-oidc-user-service)
	
	- [ID Token Signature Verification](https://docs.spring.io/spring-security/reference/servlet/oauth2/login/advanced.html#oauth2login-advanced-idtoken-verify) -OpenID Connect 1.0 Authentication introduces the¬†[ID Token](https://openid.net/specs/openid-connect-core-1_0.html#IDToken), which is a security token that contains Claims about the Authentication of an End-User by an Authorization Server when used by a Client for example
		- ![](https://i.imgur.com/f3cKu7R.png)
	
	- [oauth2login-advanced-oidc-logout](https://docs.spring.io/spring-security/reference/servlet/oauth2/login/advanced.html#oauth2login-advanced-oidc-logout)